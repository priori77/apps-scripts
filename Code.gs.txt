// ì„¤ì • ê°’
const SLACK_WEBHOOK_URL = 'url'; // Slack Webhook URL
const SPREADSHEET_ID = 'id'; // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
const SHEET_NAME = 'M15 Test Report'; // ì‹œíŠ¸ ì´ë¦„
const SLACK_BOT_TOKEN = 'token'; // Slack Bot Token (slash commandìš©)

// ë©”ì¸ í•¨ìˆ˜

// ë§¤ì¼ ì˜¤ì „ 8ì‹œ ìë™ ì‹¤í–‰ í•¨ìˆ˜
function sendDailyReport() {
  try {
    const currentData = getTestData();  
    const previousData = getPreviousData();
    const comparison = compareData(currentData, previousData);
    
    // í˜„ì¬ ë°ì´í„° ì €ì¥ (ë‹¤ìŒë‚  ë¹„êµìš©)
    saveTodayData(currentData);
    
    // Slack ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
    const message = createSlackMessage(currentData, comparison);
    sendToSlack(message);
    
    console.log('Daily report sent successfully');
  } catch (error) {
    console.error('Error sending daily report:', error);
    sendErrorToSlack(error);
  }
}

// í…ŒìŠ¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
 
function getTestData() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  
  // F20:J29 ë²”ìœ„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œ ì§‘ê³„ ë°ì´í„° ìœ„ì¹˜)
  const dataRange = sheet.getRange('C20:K29');
  const values = dataRange.getValues();
  
  const data = {
    timestamp: new Date(),
    categories: [],
    total: {
      tests: 0,
      pass: 0,
      fail: 0,
      blocked: 0,
      na: 0,
      nt: 0,
      passRate: 0
    }
  };
  
  // ê° ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„° íŒŒì‹±
  values.forEach((row, index) => {
    if (row[0] && row[0] !== '') { // ì¹´í…Œê³ ë¦¬ëª…ì´ ìˆëŠ” ê²½ìš°
      const category = {
        name: row[0],
        total: row[1] || 0,
        coverage: row[2] || 0,
        pass: row[3] || 0,
        fail: row[4] || 0,
        blocked: row[5] || 0,
        na: row[6] || 0,
        nt: row[7] || 0,
        passRate: row[8] || 0
      };
      
      data.categories.push(category);
      
      // ì „ì²´ í•©ê³„ ê³„ì‚°
      data.total.tests += Number(category.total) || 0;
      data.total.pass += Number(category.pass) || 0;
      data.total.fail += Number(category.fail) || 0;
      data.total.blocked += Number(category.blocked) || 0;
      data.total.na += Number(category.na) || 0;
      data.total.nt += Number(category.nt) || 0;
    }
  });
  
  // Pass Rate ê³„ì‚°
  if (data.total.tests > 0) {
    data.total.passRate = ((data.total.pass / data.total.tests) * 100).toFixed(2);
  }
  
  // Build ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  data.buildInfo = sheet.getRange('D10').getValue(); // Build Info
  data.deploymentDate = sheet.getRange('D12').getValue(); // Deployment Date
  data.qaLead = sheet.getRange('D13').getValue(); // QA Lead
  
  return data;
}

// ì´ì „ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Properties Service ì‚¬ìš©)
function getPreviousData() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const previousDataJson = scriptProperties.getProperty('previousTestData');
  
  if (previousDataJson) {
    return JSON.parse(previousDataJson);
  }
  
  return null;
}

// ì˜¤ëŠ˜ ë°ì´í„° ì €ì¥
function saveTodayData(data) {
  const scriptProperties = PropertiesService.getScriptProperties();
  scriptProperties.setProperty('previousTestData', JSON.stringify(data));
}

// ë°ì´í„° ë¹„êµ
function compareData(current, previous) {
  if (!previous) {
    return null;
  }
  
  return {
    totalDiff: current.total.tests - previous.total.tests,
    passDiff: current.total.pass - previous.total.pass,
    failDiff: current.total.fail - previous.total.fail,
    blockedDiff: current.total.blocked - previous.total.blocked,
    naDiff: current.total.na - previous.total.na,
    ntDiff: current.total.nt - previous.total.nt,
    passRateDiff: (parseFloat(current.total.passRate) - parseFloat(previous.total.passRate)).toFixed(2)
  };
}

// Slack ë©”ì‹œì§€ ìƒì„±
function createSlackMessage(data, comparison) {
  const kstDate = Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy-MM-dd HH:mm');
  
  // ì´ëª¨ì§€ ì„¤ì •
  const getEmoji = (value) => {
    if (value > 0) return 'ğŸ“ˆ';
    if (value < 0) return 'ğŸ“‰';
    return 'â–';
  };
  
  const getStatusEmoji = (passRate) => {
    if (passRate >= 95) return 'ğŸŸ¢';
    if (passRate >= 80) return 'ğŸŸ¡';
    return 'ğŸ”´';
  };
  
  // ê¸°ë³¸ ë©”ì‹œì§€ ë¸”ë¡
  const blocks = [
    {
      type: 'header',
      text: {
        type: 'plain_text',
        text: 'ğŸ§ª M15 Daily Test Report',
        emoji: true
      }
    },
    {
      type: 'context',
      elements: [
        {
          type: 'mrkdwn',
          text: `ğŸ“… *${kstDate} (KST)* | Build: *${data.buildInfo}*`
        }
      ]
    },
    {
      type: 'divider'
    },
    {
      type: 'section',
      fields: [
        {
          type: 'mrkdwn',
          text: `*Total Tests*\n${data.total.tests}`
        },
        {
          type: 'mrkdwn',
          text: `*Pass Rate* ${getStatusEmoji(data.total.passRate)}\n${data.total.passRate}%`
        }
      ]
    },
    {
      type: 'section',
      fields: [
        {
          type: 'mrkdwn',
          text: `âœ… *Pass:* ${data.total.pass}`
        },
        {
          type: 'mrkdwn',
          text: `âŒ *Fail:* ${data.total.fail}`
        },
        {
          type: 'mrkdwn',
          text: `âš ï¸ *Blocked:* ${data.total.blocked}`
        },
        {
          type: 'mrkdwn',
          text: `â­ï¸ *N/A:* ${data.total.na}`
        },
        {
          type: 'mrkdwn',
          text: `ğŸš« *N/T:* ${data.total.nt}`
        },
        {
          type: 'mrkdwn',
          text: ' '
        }
      ]
    }
  ];
  
  // ì „ë‚  ëŒ€ë¹„ ë³€í™” ì¶”ê°€
  if (comparison) {
    const changeText = [];
    
    if (comparison.totalDiff !== 0) {
      changeText.push(`â€¢ Total: ${comparison.totalDiff > 0 ? '+' : ''}${comparison.totalDiff} ${getEmoji(comparison.totalDiff)}`);
    }
    if (comparison.passDiff !== 0) {
      changeText.push(`â€¢ Pass: ${comparison.passDiff > 0 ? '+' : ''}${comparison.passDiff} ${getEmoji(comparison.passDiff)}`);
    }
    if (comparison.failDiff !== 0) {
      changeText.push(`â€¢ Fail: ${comparison.failDiff > 0 ? '+' : ''}${comparison.failDiff} ${getEmoji(-comparison.failDiff)}`);
    }
    if (comparison.passRateDiff != 0) {
      changeText.push(`â€¢ Pass Rate: ${comparison.passRateDiff > 0 ? '+' : ''}${comparison.passRateDiff}% ${getEmoji(comparison.passRateDiff)}`);
    }
    
    if (changeText.length > 0) {
      blocks.push({
        type: 'divider'
      });
      blocks.push({
        type: 'section',
        text: {
          type: 'mrkdwn',
          text: `*ğŸ“Š Changes from Yesterday*\n${changeText.join('\n')}`
        }
      });
    }
  }
  
  // ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ì •ë³´
  if (data.categories.length > 0) {
    blocks.push({
      type: 'divider'
    });
    
    let categoryText = '*ğŸ“‹ Category Details*\n```\n';
    categoryText += 'Category         | Total | Pass | Fail | Pass Rate\n';
    categoryText += '-----------------|-------|------|------|----------\n';
    
    data.categories.forEach(cat => {
      const name = (cat.name + '                ').substring(0, 16);
      const total = (cat.total + '       ').substring(0, 5);
      const pass = (cat.pass + '      ').substring(0, 4);
      const fail = (cat.fail + '      ').substring(0, 4);
      const passRate = cat.passRate ? `${(cat.passRate * 100).toFixed(1)}%` : '0.0%';
      
      categoryText += `${name} | ${total} | ${pass} | ${fail} | ${passRate}\n`;
    });
    categoryText += '```';
    
    blocks.push({
      type: 'section',
      text: {
        type: 'mrkdwn',
        text: categoryText
      }
    });
  }
  
  // Footer
  blocks.push({
    type: 'context',
    elements: [
      {
        type: 'mrkdwn',
        text: `QA Lead: *${data.qaLead}* | <https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}|View Spreadsheet>`
      }
    ]
  });
  
  return { blocks: blocks };
}

// Slackìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
function sendToSlack(message) {
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(message)
  };
  
  UrlFetchApp.fetch(SLACK_WEBHOOK_URL, options);
}

// ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡
function sendErrorToSlack(error) {
  const message = {
    blocks: [
      {
        type: 'section',
        text: {
          type: 'mrkdwn',
          text: `âš ï¸ *Error in Test Report*\n\`\`\`${error.toString()}\`\`\``
        }
      }
    ]
  };
  
  sendToSlack(message);
}

// ìˆ˜ë™ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testSendReport() {
  sendDailyReport();
}